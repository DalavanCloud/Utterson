#!/usr/bin/env bash
set -e

RESULTS="$(pwd)/results.csv"
NUMBER_OF_RUNS=3

if command -v gtime; then
	TIME=$(which gtime)
else
	TIME=$(which time)
fi

# Create tmp/ directory
export TMPDIR="$(pwd)/sites"
if [[ -d $TMPDIR ]]; then
	rm -rf "$TMPDIR"
fi
mkdir -p "$TMPDIR/source"
mkdir -p "$TMPDIR/destination"

for SITE in $(cat "site-list"); do
	SOURCE=$(mktemp -d "$TMPDIR/source/XXXXXX")
	DESTINATION=${SOURCE/source/destination}
	git clone --recurse-submodules -q "$SITE" "$SOURCE"
	if [[ -f "$SOURCE/Gemfile" ]]; then
		export BUNDLE_GEMFILE="$SOURCE/Gemfile"
	else
		export BUNDLE_GEMFILE="$(pwd)/Gemfile"
	fi
	echo "$BUNDLE_GEMFILE"
	bundle install
	for ((i=0; i<NUMBER_OF_RUNS; ++i)); do
		"$TIME" -ao "$RESULTS" -f"%P,%U,%e,$SITE" \
			bundle exec jekyll build -s "$SOURCE" -d "$DESTINATION" --trace
	done
done
